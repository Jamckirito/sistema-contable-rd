# ğŸ—ï¸ Arquitectura de Seguridad - Diagrama Visual

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         USUARIO FINAL                                â”‚
â”‚                    (Navegador Web / Cliente)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â”‚ HTTPS (SSL/TLS)
                             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      REACT FRONTEND                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Login.tsx                                                    â”‚  â”‚
â”‚  â”‚  â”œâ”€ Formulario de login                                      â”‚  â”‚
â”‚  â”‚  â”œâ”€ ValidaciÃ³n de campos                                     â”‚  â”‚
â”‚  â”‚  â””â”€ EnvÃ­o de credenciales vÃ­a POST /auth/login              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ProtectedRoute                                              â”‚  â”‚
â”‚  â”‚  â”œâ”€ Verifica token en localStorage                          â”‚  â”‚
â”‚  â”‚  â”œâ”€ Redirige a /login si no autenticado                     â”‚  â”‚
â”‚  â”‚  â””â”€ Permite acceso si autenticado                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  API Service (Axios)                                         â”‚  â”‚
â”‚  â”‚  â”œâ”€ Interceptor Request: Agrega Bearer token                â”‚  â”‚
â”‚  â”‚  â”œâ”€ Interceptor Response: Logout en 401                     â”‚  â”‚
â”‚  â”‚  â””â”€ Base URL: http://localhost:3000/api                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Auth Store (Zustand + localStorage)                        â”‚  â”‚
â”‚  â”‚  â”œâ”€ user: { id, nombre, rol, permisos }                     â”‚  â”‚
â”‚  â”‚  â”œâ”€ accessToken (JWT)                                        â”‚  â”‚
â”‚  â”‚  â”œâ”€ refreshToken (JWT)                                       â”‚  â”‚
â”‚  â”‚  â””â”€ isAuthenticated: boolean                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â”‚ HTTP/JSON
                             â”‚ Header: Authorization: Bearer <token>
                             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    EXPRESS.JS SERVER                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  MIDDLEWARE CHAIN (en orden)                                 â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  1. Helmet.js                                                â”‚  â”‚
â”‚  â”‚     â””â”€ Headers de seguridad (X-Frame-Options, etc.)         â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  2. CORS                                                     â”‚  â”‚
â”‚  â”‚     â””â”€ Origin: localhost:5173 (dev) / tu-dominio.com (prod) â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  3. Rate Limiter                                             â”‚  â”‚
â”‚  â”‚     â””â”€ 100 requests / 15 minutos por IP                     â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  4. Express.json()                                           â”‚  â”‚
â”‚  â”‚     â””â”€ Parseo de body JSON (limit: 10mb)                    â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  5. Morgan Logger                                            â”‚  â”‚
â”‚  â”‚     â””â”€ Log de todos los requests                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  AUTHENTICATION ROUTES                                       â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  POST /api/auth/login                                        â”‚  â”‚
â”‚  â”‚  â”œâ”€ ValidaciÃ³n de credenciales                              â”‚  â”‚
â”‚  â”‚  â”œâ”€ BÃºsqueda de usuario en BD                               â”‚  â”‚
â”‚  â”‚  â”œâ”€ VerificaciÃ³n bcrypt.compare()                           â”‚  â”‚
â”‚  â”‚  â”œâ”€ GeneraciÃ³n de JWT tokens                                â”‚  â”‚
â”‚  â”‚  â”œâ”€ CreaciÃ³n de sesiÃ³n en BD                                â”‚  â”‚
â”‚  â”‚  â””â”€ Retorno de { accessToken, refreshToken, usuario }       â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  POST /api/auth/refresh-token                               â”‚  â”‚
â”‚  â”‚  â”œâ”€ VerificaciÃ³n de refresh token                           â”‚  â”‚
â”‚  â”‚  â”œâ”€ GeneraciÃ³n de nuevo access token                        â”‚  â”‚
â”‚  â”‚  â””â”€ ActualizaciÃ³n en tabla sesiones                         â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  POST /api/auth/logout                                       â”‚  â”‚
â”‚  â”‚  â”œâ”€ Middleware: authenticate                                â”‚  â”‚
â”‚  â”‚  â”œâ”€ InvalidaciÃ³n de sesiÃ³n (activa = false)                â”‚  â”‚
â”‚  â”‚  â””â”€ Log de auditorÃ­a                                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  PROTECTED ROUTES (requieren auth)                          â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  Middleware: authenticate                                    â”‚  â”‚
â”‚  â”‚  â”œâ”€ Extrae token del header Authorization                   â”‚  â”‚
â”‚  â”‚  â”œâ”€ Verifica JWT con jwt.verify()                           â”‚  â”‚
â”‚  â”‚  â”œâ”€ Busca usuario en BD                                      â”‚  â”‚
â”‚  â”‚  â”œâ”€ Verifica que estÃ© activo                                â”‚  â”‚
â”‚  â”‚  â””â”€ Agrega req.user = { id, rol, permisos }                 â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  Middleware: authorize(['facturas:crear'])                  â”‚  â”‚
â”‚  â”‚  â”œâ”€ Verifica que req.user existe                            â”‚  â”‚
â”‚  â”‚  â”œâ”€ Compara permisos requeridos vs permisos del usuario     â”‚  â”‚
â”‚  â”‚  â””â”€ 403 si no tiene permiso, next() si tiene               â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  POST /api/facturas    [auth] [authorize('facturas:crear')] â”‚  â”‚
â”‚  â”‚  GET  /api/clientes    [auth] [authorize('clientes:ver')]   â”‚  â”‚
â”‚  â”‚  POST /api/asientos    [auth] [authorize('contabilidad:*')] â”‚  â”‚
â”‚  â”‚  GET  /api/reportes    [auth] [authorize('reportes:ver')]   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ERROR HANDLER                                               â”‚  â”‚
â”‚  â”‚  â”œâ”€ Captura todos los errores                               â”‚  â”‚
â”‚  â”‚  â”œâ”€ Log con Winston (archivo + consola)                     â”‚  â”‚
â”‚  â”‚  â”œâ”€ Oculta stack traces en producciÃ³n                       â”‚  â”‚
â”‚  â”‚  â””â”€ Retorna JSON { success: false, message }                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â”‚ Prisma ORM
                             â”‚ (SQL Parametrizado)
                             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      POSTGRESQL DATABASE                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  TABLA: usuarios                                             â”‚  â”‚
â”‚  â”‚  â”œâ”€ id (UUID)                                                â”‚  â”‚
â”‚  â”‚  â”œâ”€ nombreUsuario (UNIQUE)                                   â”‚  â”‚
â”‚  â”‚  â”œâ”€ email (UNIQUE)                                           â”‚  â”‚
â”‚  â”‚  â”œâ”€ password (BCRYPT HASH) â† NO ALMACENA EN TEXTO PLANO     â”‚  â”‚
â”‚  â”‚  â”œâ”€ nombreCompleto                                           â”‚  â”‚
â”‚  â”‚  â”œâ”€ rolId â†’ FK a roles                                       â”‚  â”‚
â”‚  â”‚  â””â”€ activo (BOOLEAN)                                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  TABLA: roles                                                â”‚  â”‚
â”‚  â”‚  â”œâ”€ id (UUID)                                                â”‚  â”‚
â”‚  â”‚  â”œâ”€ nombre (Administrador, Contador, etc.)                  â”‚  â”‚
â”‚  â”‚  â”œâ”€ descripcion                                              â”‚  â”‚
â”‚  â”‚  â”œâ”€ permisos (JSON ARRAY)                                    â”‚  â”‚
â”‚  â”‚  â”‚   â””â”€ ['facturas:crear', 'clientes:*', '*']              â”‚  â”‚
â”‚  â”‚  â””â”€ activo                                                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  TABLA: sesiones                                             â”‚  â”‚
â”‚  â”‚  â”œâ”€ id (UUID)                                                â”‚  â”‚
â”‚  â”‚  â”œâ”€ usuarioId â†’ FK a usuarios                                â”‚  â”‚
â”‚  â”‚  â”œâ”€ token (ACCESS TOKEN JWT)                                 â”‚  â”‚
â”‚  â”‚  â”œâ”€ refreshToken (REFRESH TOKEN JWT)                         â”‚  â”‚
â”‚  â”‚  â”œâ”€ ipAddress â† TRACKING                                     â”‚  â”‚
â”‚  â”‚  â”œâ”€ userAgent â† TRACKING                                     â”‚  â”‚
â”‚  â”‚  â”œâ”€ expiraEn (TIMESTAMP)                                     â”‚  â”‚
â”‚  â”‚  â”œâ”€ activa (BOOLEAN) â† Para revocar                         â”‚  â”‚
â”‚  â”‚  â””â”€ createdAt                                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  TABLA: auditorias                                           â”‚  â”‚
â”‚  â”‚  â”œâ”€ id (UUID)                                                â”‚  â”‚
â”‚  â”‚  â”œâ”€ usuarioId â†’ FK a usuarios                                â”‚  â”‚
â”‚  â”‚  â”œâ”€ accion (CREATE/UPDATE/DELETE/READ)                      â”‚  â”‚
â”‚  â”‚  â”œâ”€ modulo (FACTURACION/CONTABILIDAD/etc.)                  â”‚  â”‚
â”‚  â”‚  â”œâ”€ tabla (nombre de tabla afectada)                        â”‚  â”‚
â”‚  â”‚  â”œâ”€ registroId (ID del registro modificado)                 â”‚  â”‚
â”‚  â”‚  â”œâ”€ datosAntes (JSON) â† Estado anterior                     â”‚  â”‚
â”‚  â”‚  â”œâ”€ datosDespues (JSON) â† Estado nuevo                      â”‚  â”‚
â”‚  â”‚  â”œâ”€ ipAddress                                                â”‚  â”‚
â”‚  â”‚  â””â”€ createdAt                                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        FLUJO DE AUTENTICACIÃ“N
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. USUARIO ENVÃA CREDENCIALES
   POST /api/auth/login
   Body: { nombreUsuario: "admin", password: "admin123" }

2. SERVIDOR VALIDA
   â”œâ”€ Busca usuario por nombreUsuario
   â”œâ”€ Verifica usuario.activo === true
   â””â”€ bcrypt.compare(password, usuario.password)

3. GENERA TOKENS JWT
   â”œâ”€ accessToken = jwt.sign({ userId }, SECRET, { expiresIn: '24h' })
   â””â”€ refreshToken = jwt.sign({ userId }, SECRET, { expiresIn: '7d' })

4. GUARDA SESIÃ“N EN BD
   INSERT INTO sesiones (usuarioId, token, refreshToken, ipAddress, ...)

5. RETORNA AL CLIENTE
   Response: { 
     success: true,
     data: {
       accessToken: "eyJhbGciOiJIUzI1NiIs...",
       refreshToken: "eyJhbGciOiJIUzI1NiIs...",
       usuario: { id, nombre, rol, permisos }
     }
   }

6. CLIENTE GUARDA EN LOCALSTORAGE
   localStorage.setItem('auth-storage', JSON.stringify({
     user: usuario,
     accessToken: token,
     refreshToken: refresh,
     isAuthenticated: true
   }))

7. REQUESTS SUBSECUENTES
   Headers: { 
     Authorization: "Bearer eyJhbGciOiJIUzI1NiIs..." 
   }

8. SERVIDOR VALIDA TOKEN
   â”œâ”€ jwt.verify(token, SECRET)
   â”œâ”€ Busca usuario en BD
   â”œâ”€ Verifica permisos para endpoint
   â””â”€ next() o 401/403


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    SISTEMA DE PERMISOS (RBAC)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ROL: Administrador
Permisos: ['*']
Acceso: TODO

ROL: Contador
Permisos: [
  'contabilidad:*',
  'reportes:*',
  'facturas:ver',
  'clientes:ver'
]
Acceso: Contabilidad completa, reportes, solo ver facturas

ROL: Vendedor
Permisos: [
  'facturas:crear',
  'facturas:ver',
  'clientes:*',
  'inventario:ver'
]
Acceso: FacturaciÃ³n y clientes, solo ver inventario

ROL: Almacenista
Permisos: [
  'inventario:*',
  'productos:*',
  'compras:ver'
]
Acceso: Inventario completo, solo ver compras

ROL: Consulta
Permisos: [
  'facturas:ver',
  'clientes:ver',
  'inventario:ver',
  'reportes:ver'
]
Acceso: Solo lectura en todo


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        CAPAS DE PROTECCIÃ“N
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Capa 1: HTTPS/SSL                                               â”‚
â”‚ â””â”€ EncriptaciÃ³n en trÃ¡nsito                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Capa 2: CORS + Helmet                                           â”‚
â”‚ â””â”€ Headers seguros, orÃ­genes permitidos                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Capa 3: Rate Limiting                                           â”‚
â”‚ â””â”€ PrevenciÃ³n de brute force y DDoS                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Capa 4: JWT Authentication                                      â”‚
â”‚ â””â”€ Tokens firmados con expiraciÃ³n                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Capa 5: Authorization (RBAC)                                    â”‚
â”‚ â””â”€ Permisos granulares por rol                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Capa 6: Input Validation                                        â”‚
â”‚ â””â”€ Zod schemas, sanitizaciÃ³n                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Capa 7: Prisma ORM                                              â”‚
â”‚ â””â”€ SQL injection protection                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Capa 8: Password Hashing                                        â”‚
â”‚ â””â”€ bcrypt salt 10                                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Capa 9: Session Management                                      â”‚
â”‚ â””â”€ RevocaciÃ³n, tracking, expiraciÃ³n                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Capa 10: Audit Logging                                          â”‚
â”‚ â””â”€ Rastreabilidad completa de acciones                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                      VECTORES DE ATAQUE MITIGADOS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… SQL Injection          â†’ Prisma ORM (queries parametrizadas)
âœ… XSS                    â†’ React sanitization + Helmet CSP
âœ… CSRF                   â†’ SameSite cookies + CORS
âœ… Brute Force            â†’ Rate limiting + account lockout
âœ… Session Hijacking      â†’ HTTPS + httpOnly cookies
âœ… Man-in-the-Middle      â†’ HTTPS/TLS
âœ… Password Cracking      â†’ bcrypt salt 10
âœ… Privilege Escalation   â†’ RBAC + middleware validation
âœ… Directory Traversal    â†’ Path sanitization
âœ… Information Disclosure â†’ Error handling genÃ©rico
âœ… DDoS                   â†’ Rate limiting + load balancing
âœ… JWT Tampering          â†’ Signature verification

```

**Este diagrama muestra la arquitectura de seguridad completa del sistema.**
